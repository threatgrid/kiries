;; -*- mode: clojure; -*-
;;
;; sample configuration for Kiries

(require '[kiries.jvm :as jvm])
(require '[kiries.redis :as redis])
(require '[kiries.elastic :as elastic])

(def elastic-addr "http://localhost:9200")

(def redis-addr {:host "127.0.0.1" :port 6749})

(def vm-prefix "kiries")

(def monitored-keys "some-keys-*")

(logging/init)

(tcp-server)
(udp-server)

(defn stream-event [event]
  (riemann.core/stream! @riemann.config/core event))

;; Local JVM

(every! 10 #(doseq [event (jvm/vm-metrics :prefix vm-prefix)]
              (stream-event event)))

;; Redis

(every! 10 #(doseq [[k v] (redis/key-lengths redis-addr monitored-keys)]
              (stream-event {:service k :metric (str "redis " v)})))

;; Elasticsearch

(def connection (elastic/es-connect elastic-addr))

(streams
 (rollup 1 5 (elastic/es-index connection "metric"
                               :timestamping :day
                               :index "metrics")))
